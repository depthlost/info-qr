{% extends "base.html" %}

{% block title %}Info QR{% endblock %}

{% block body_content %}
    <h1 class="display-5">¡Bienvenid@ a InfoQR!</h1>
    <p class="lead">Esta aplicación te permite obtener información sobre una persona para brindarle ayuda, de forma rápida y práctica mediante el escaneo de un código QR o ingresando un identificador único.</p>
    
    <div class="text-center mt-4">
        <button id="scanQrButton" class="btn btn-success btn-lg" type="button" aria-labelledby="scanQrButtonText">
            <i class="bi bi-qr-code-scan me-2" aria-hidden="true"></i>
            <span id="scanQrButtonText">Escanear Código QR</span>
        </button>
    </div>

    <div id="qrReaderError" class="invalid-feedback d-block text-center" aria-live="polite"></div>
    
    <div class="d-flex justify-content-center">
        <div id="qrReader" style="max-width: 320px; width: 100%; height: auto;"></div>
    </div>
    
    
    <hr class="my-4">
    
    <form id="searchForm" class="row g-3 justify-content-around" role="search" aria-label="Formulario para buscar por identificador" novalidate>
        <div class="col-md-6">
            <label for="identifier" class="form-label">Ingresar Identificador</label>
            <input type="text" id="identifier" name="identifier" class="form-control" placeholder="Ejemplo: fb22d174-f2d7-42e2-abf7-72e2c7118c6d" aria-describedby="identifierHelp" required>
            <div id="identifierHelp" class="form-text">
                Introduce un identificador único para buscar la información.
            </div>
            <div id="identifierError" class="invalid-feedback" aria-live="polite"></div>
        </div>
        <div class="col-md-3 align-self-center">
            <button type="submit" class="btn btn-primary w-100" aria-label="Buscar identificador">Buscar</button>
        </div>
    </form>
{% endblock %}

{% block script %}
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <script>
        const searchForm = document.getElementById('searchForm');
        const identifierInput = document.getElementById('identifier');
        const identifierErrorDiv = document.getElementById('identifierError');
        const uuidRegex = /^{{ uuid_regex }}$/;

        searchForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const identifier = identifierInput.value.trim();
            
            if (!uuidRegex.test(identifier)) {
                identifierInput.classList.add('is-invalid');
                identifierErrorDiv.textContent = 'El identificador ingresado no es válido.';
            } else {
                identifierInput.classList.remove('is-invalid');
                window.location.href = `{{ url_for('show_user', user_id='') }}${encodeURIComponent(identifier)}`;
            }
        });
    </script>

    <script>
        const scanQrButton = document.getElementById("scanQrButton")
        const scanQrButtonText = document.getElementById("scanQrButtonText")
        const qrReaderDiv = document.getElementById('qrReader');
        const qrReaderErrorDiv = document.getElementById('qrReaderError');
        const userUrlRegex = /^{{ user_url_regex }}$/;

        let html5QrCode = new Html5Qrcode("qrReader")
        let html5QrCodeIsStoping = false;

        function setQrReaderError(message) {
            if (message) {
                qrReaderErrorDiv.classList.add('mt-4');
                qrReaderErrorDiv.textContent = message
            } else {
                qrReaderErrorDiv.classList.remove('mt-4');
                qrReaderErrorDiv.textContent = ''
            }
        }

        function updateQrScannerState() {
            if (html5QrCode.getState() != Html5QrcodeScannerState.SCANNING) {
                scanQrButtonText.textContent = "Escanear Código QR"
                scanQrButton.classList.add('btn-success');
                scanQrButton.classList.remove('btn-danger');
                qrReaderDiv.classList.remove('mt-4');
            } else {
                scanQrButtonText.textContent = "Detener Escaneo"
                scanQrButton.classList.remove('btn-success');
                scanQrButton.classList.add('btn-danger');
                qrReaderDiv.classList.add('mt-4');
            }

            setQrReaderError('')
        }        

        updateQrScannerState()

        scanQrButton.addEventListener("click", () => {
            if (html5QrCode.getState() != Html5QrcodeScannerState.SCANNING) {
                html5QrCode
                    .start(
                        { facingMode: "environment" }, 
                        { fps: 10, qrbox: 250 },
                        qrData => {                            
                            if (html5QrCodeIsStoping)
                                return;

                            if (!userUrlRegex.test(qrData)) {
                                setQrReaderError('El código QR escaneado no es válido.')
                            } else {
                                html5QrCodeIsStoping = true;
                                setQrReaderError('')
                                
                                html5QrCode
                                    .stop()
                                    .then(() => window.location.href = qrData)
                                    .catch(() => {
                                        setQrReaderError('No se pudo detener el escáner.')
                                        html5QrCodeIsStoping = false;
                                    })                                   
                            }
                        }
                    )
                    .then(() => updateQrScannerState())
                    .catch(() => setQrReaderError('No se pudo iniciar el escáner.'))
            } else {
                html5QrCode
                    .stop()
                    .then(() => updateQrScannerState())
                    .catch(() => setQrReaderError('No se pudo detener el escáner.'))
            }
        })
    </script>
{% endblock %}